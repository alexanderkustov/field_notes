{{ $pages := .Pages }}
{{ $features := slice }}
{{ $mapBounds := nil }}
{{ range $pages }}
  {{ $page := . }}
  {{ with .Params.location }}
    {{ with .map_bounds }}
      {{ if not $mapBounds }}
        {{ $mapBounds = . }}
      {{ end }}
    {{ end }}
    {{ with .coordinates }}
      {{ if and .latitude .longitude }}
        {{ $summary := "" }}
        {{ with $page.Params.summary }}
          {{ $summary = . }}
        {{ else }}
          {{ with $page.Summary }}
            {{ $summary = . | plainify }}
          {{ end }}
        {{ end }}
        {{ $feature := dict "title" $page.Title "permalink" $page.RelPermalink "latitude" .latitude "longitude" .longitude "summary" $summary }}
        {{ $features = $features | append $feature }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ define "main" }}
<main class="city-category">
  <header class="page-header">
    <h1>{{ .Title }}</h1>
    {{ with .Description }}
      <p class="page-description">{{ . }}</p>
    {{ end }}
    {{ with .Content }}
      <div class="page-intro">{{ . }}</div>
    {{ end }}
  </header>

  <div class="city-category__map" id="city-map"></div>

  <section class="city-category__list">
    <h2>Restaurants</h2>
    <ul>
      {{ range sort $pages "Title" }}
        <li>
          <article>
            <h3><a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a></h3>
            {{ with .Params.summary }}
              <p>{{ . }}</p>
            {{ else }}
              {{ with .Summary }}
                <p>{{ . | plainify }}</p>
              {{ end }}
            {{ end }}
            {{ with .Params.location.neighborhood }}
              <p class="city-category__neighborhood">{{ . }}</p>
            {{ end }}
          </article>
        </li>
      {{ else }}
        <li>No restaurants found for this city yet.</li>
      {{ end }}
    </ul>
  </section>

  <script type="application/json" id="city-map-features">{{ $features | jsonify }}</script>
  {{ if $mapBounds }}
    <script type="application/json" id="city-map-bounds">{{ $mapBounds | jsonify }}</script>
  {{ end }}
</main>
{{ end }}
